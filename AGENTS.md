# AGENTS.md

This file provides context, rules, and instructions for AI agents working on the **Bassaleg Assessment Calendar** project. Adhere to these guidelines to ensure code quality, performance, and stability.

## 1. Project Overview

This is a React application (Vite + TypeScript + Tailwind CSS) that visualizes assessment timetables. It parses Google Sheets data into a JSON format and presents it in two views: a **Monthly Calendar** and a **Linear Timeline**.

### Key Characteristics
-   **Dual Build**: The project is deployed as two separate instances (Year 10 and Year 11) from the same codebase. The difference is solely the source data URL.
-   **Static Data**: Data is fetched at build time. The app reads from `src/data.json`.
-   **Performance Focused**: Rendering large schedules requires O(N) optimizations.

## 2. Critical Rules & Constraints

### ðŸ›‘ Strict Rules (Do Not Break)
1.  **Edit Source, Not Artifacts**: Never manually edit `dist/` or `src/data.json` (unless for temporary local testing). `src/data.json` is generated by scripts.
2.  **Strict Visuals**: If a specific hex code is requested (e.g., `#F5F5F5`), use it exactly. Do not approximate with Tailwind utilities (like `bg-gray-100`) unless explicitly allowed.
3.  **No Nested Components**: Never define a React component inside another component's function body. This causes remounts and performance degradation.
4.  **Window Mocking**: When testing code that touches `window.location` or `window.history`, you **must** use `Object.defineProperty` in Vitest to avoid read-only errors.
5.  **Strict Linting**: The build uses `noUnusedLocals: true`. The build *will* fail if you leave unused variables or imports. Run `npm run lint` frequently.

### ðŸŽ¨ UX & Accessibility
-   **Sticky Elements**: Sticky headers/banners must be nested in the main sticky container to ensure proper stacking. Do not use manual `top` offsets if avoidable.
-   **Filters**: Toggle buttons must use `aria-pressed` to communicate state to screen readers.
-   **Past Events**: Visually de-emphasize past events (e.g., 60% opacity) but ensure text contrast remains accessible (keep text dark).
-   **Icons**: Use inline SVGs. Do not install icon libraries like FontAwesome.

## 3. Architecture & Data Flow

### Data Pipeline
1.  **Source**: Google Sheets (managed by school staff).
2.  **Fetch Script**: `scripts/download-and-parse.js` downloads the sheet (as XLSX) and parses it.
    -   **Input**: `SHEET_URL` env var OR `scripts/year-10-sheet-url.txt` (default).
    -   **Output**: `src/data.json`.
3.  **Application**: React loads `src/data.json` via import or `window.APP_DATA` injection (for E2E).

### Multi-Year Deployment
The GitHub Actions workflow runs the build twice:
1.  **Year 10**: Uses URL from `scripts/year-10-sheet-url.txt`.
2.  **Year 11**: Uses URL from `scripts/year-11-sheet-url.txt`.
*Note: When working locally, `node scripts/download-and-parse.js` defaults to Year 10 data.*

## 4. Development Workflow

### Setup & Run
```bash
npm install
node scripts/download-and-parse.js  # Generate necessary data.json
npm run dev
```

### Verification Checklist
Before requesting submission, run:
1.  `npm run lint` (Fix all warnings)
2.  `npm run typecheck` (or `tsc -b` if not defined) to verify types.
3.  `npm run test` (Unit tests)
4.  `npm run build` (Ensures production build works)
5.  `npm run test:e2e` (Run E2E against the production build)

## 5. Testing Strategy

### Unit Tests (Vitest)
-   **Mocking Data**: Use `vi.doMock` to mock `src/data.json`. Reset modules between tests.
-   **Dates**: Logic is sensitive to "current date". Use `vi.useFakeTimers({ toFake: ['Date'] })` when testing time-dependent logic to prevent timeouts or race conditions.
-   **Interaction**: Use `@testing-library/user-event` instead of `fireEvent`.

### End-to-End (Playwright)
-   **Environment**: Tests run against `preview` (production build), not dev server.
-   **Data Injection**: E2E tests often inject mock data via `window.APP_DATA`.
-   **Date Mocking**: Use `page.add_init_script` to mock `Date` if testing specific schedule scenarios (e.g., ensuring "Future" events are visible).
-   **Title Checks**: The document title is dynamic based on the loaded filename. Do not assert static titles like "Vite App".

## 6. Coding Standards

### React & Performance
-   **Memoization**: `TimelineView` is heavy. It uses `React.memo`. Ensure props passed to it (callbacks) are stable (`useCallback`).
-   **Loops**: Avoid O(N*M) lookups in render loops. Use `Map` or Sets for data access inside loops.
-   **Date Handling**:
    -   Avoid `new Date()` inside loops.
    -   Use `src/utils/dateUtils.ts` for relative time logic ("Today", "Yesterday").
    -   Handle ISO strings by substring (first 10 chars) to avoid timezone shifts.

### File Structure
-   **Components**: Top-level definitions only.
-   **Tests**: Co-located with components (`Component.test.tsx`) or in `e2e/`.
